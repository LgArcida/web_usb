<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:title" content="">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">
  <script src="./libs/serial.js"></script>
  <script src="./libs/divider.js"></script>
</head>

<body>

  <button id="click" style="margin-bottom: 1em; display: block"> Connect to Arduino 5</button>

  <button id="high_btn" style="margin-bottom: 1em; display: block"> Turn led on! </button>
  <button id="low_btn" style="margin-bottom: 1em; display: block"> Turn led off! </button>

  <div style="margin-bottom: 1em; display: block">
    <input id="str_in" type="text" value="Hello Du from WEB to arduino Leonardo!">
    <button id="json_btn"> JSON </button>
  </div>


  <script>
    serial.requestPort = () => {
      const filters = [{'vendorId': 0x2341, 'productId': 0x8036}];
      return navigator.usb.requestDevice({'filters': filters}).then(device => new serial.Port(device)).catch(() => console.log('Error on port request!'));
    }

    let port;
    let textDecoder = new TextDecoder();
    let textEncoder = new TextEncoder();
    let connectButton = document.getElementById('click');
    let ledOnButton = document.getElementById('high_btn');
    let ledOffButton = document.getElementById('low_btn');
    let jsonButton = document.getElementById('json_btn');
    let strInput = document.getElementById('str_in');

    connectButton.addEventListener('click', () => {
      if (port) {
        connectButton.textContent = 'Connected';
        port.disconnect();
        port = null;
      } else {
        serial.requestPort().then(selectedPort => {
          port = selectedPort;
          port.connect().then(() => {
            console.log('Connected!');
            connectButton.textContent = 'Diconnected';
            port.onReceive = (data) => {
              alert(JSON.stringify(data));
              dataReceived(data);
            }
            // port.onReceive = (data) => alert(textDecoder.decode(data));
          })
        })
      }
    });

    ledOnButton.addEventListener('click', () => {
      if (port) {
        port.send(textEncoder.encode('H'));
      }
    });

    ledOffButton.addEventListener('click', () => {
      if (port) {
        port.send(textEncoder.encode('L'));
      }
    });

    jsonButton.addEventListener('click', () => {
      const txt = strInput.value;
      if (port) {
        port.send(textEncoder.encode('DU'));
        /*const data = dummyJson(txt);
        for (let item of data) {
          port.send(item);
          port.send('~');
        }*/
      }
    });

  </script>


</body>

</html>
